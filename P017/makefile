.PHONY: help dev prod clean logs shell test backup restore

# Makefile para gerenciamento de ambiente Docker
# Comandos temporarios para desenvolvimento e producao

# === VARIÃVEIS ===
COMPOSE_FILE=docker-compose.yml
COMPOSE_FILE_PROD=docker-compose.prod.yml
BACKUP_DIR=./backups

# === AJUDA ===
help: ## Mostra esta ajuda
	@echo "Comandos disponÃ­veis:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# === DESENVOLVIMENTO ===
dev: ## Inicia ambiente de desenvolvimento
	@echo "ğŸš€ Iniciando ambiente de desenvolvimento..."
	docker compose -f $(COMPOSE_FILE) up -d
	@echo "âœ… Ambiente iniciado! Acesse: http://localhost:3001"

dev-build: ## Rebuild completo para desenvolvimento
	@echo "ğŸ”„ Rebuilding desenvolvimento (sem cache)..."
	docker compose -f $(COMPOSE_FILE) down --volumes --remove-orphans
	docker system prune -f
	docker compose -f $(COMPOSE_FILE) build --no-cache
	docker compose -f $(COMPOSE_FILE) up -d
	@echo "âœ… Rebuild completo!"

dev-stop: ## Para ambiente de desenvolvimento
	@echo "â¹ï¸ Parando ambiente de desenvolvimento..."
	docker compose -f $(COMPOSE_FILE) down
	@echo "âœ… Ambiente parado!"

dev-restart: ## Reinicia ambiente de desenvolvimento
	@echo "ğŸ”„ Reiniciando ambiente de desenvolvimento..."
	docker compose -f $(COMPOSE_FILE) restart
	@echo "âœ… Ambiente reiniciado!"

dev-clean: ## Limpa tudo (containers, volumes, imagens)
	@echo "ğŸ§¹ Limpando ambiente de desenvolvimento..."
	docker compose -f $(COMPOSE_FILE) down --volumes --remove-orphans
	docker system prune -af --volumes
	@echo "âœ… Limpeza completa!"

# === PRODUÃ‡ÃƒO ===
prod: ## Inicia ambiente de produÃ§Ã£o
	@echo "ğŸš€ Iniciando ambiente de produÃ§Ã£o..."
	docker compose -f $(COMPOSE_FILE_PROD) up -d
	@echo "âœ… Ambiente de produÃ§Ã£o iniciado!"

prod-build: ## Rebuild completo para produÃ§Ã£o
	@echo "ğŸ”„ Rebuilding produÃ§Ã£o (sem cache)..."
	docker compose -f $(COMPOSE_FILE_PROD) down --volumes --remove-orphans
	docker compose -f $(COMPOSE_FILE_PROD) build --no-cache
	docker compose -f $(COMPOSE_FILE_PROD) up -d
	@echo "âœ… Deploy de produÃ§Ã£o completo!"

prod-stop: ## Para ambiente de produÃ§Ã£o
	@echo "â¹ï¸ Parando ambiente de produÃ§Ã£o..."
	docker compose -f $(COMPOSE_FILE_PROD) down
	@echo "âœ… Ambiente de produÃ§Ã£o parado!"

prod-restart: ## Reinicia ambiente de produÃ§Ã£o
	@echo "ğŸ”„ Reiniciando ambiente de produÃ§Ã£o..."
	docker compose -f $(COMPOSE_FILE_PROD) restart
	@echo "âœ… Ambiente de produÃ§Ã£o reiniciado!"

prod-deploy: ## Deploy rÃ¡pido para produÃ§Ã£o (sem rebuild)
	@echo "ğŸš€ Deploy rÃ¡pido para produÃ§Ã£o..."
	docker compose -f $(COMPOSE_FILE_PROD) pull
	docker compose -f $(COMPOSE_FILE_PROD) up -d
	@echo "âœ… Deploy rÃ¡pido completo!"

# === SERVIÃ‡OS INDIVIDUAIS ===
web-build: ## Rebuild apenas o serviÃ§o web
	@echo "ğŸ”„ Rebuilding serviÃ§o web..."
	docker compose -f $(COMPOSE_FILE) build --no-cache web
	docker compose -f $(COMPOSE_FILE) up -d web
	@echo "âœ… ServiÃ§o web rebuilded!"

react-build: ## Rebuild apenas o serviÃ§o react
	@echo "ğŸ”„ Rebuilding serviÃ§o react..."
	docker compose -f $(COMPOSE_FILE) build --no-cache react-app
	docker compose -f $(COMPOSE_FILE) up -d react-app
	@echo "âœ… ServiÃ§o react rebuilded!"

db-restart: ## Reinicia apenas o banco de dados
	@echo "ğŸ”„ Reiniciando banco de dados..."
	docker compose -f $(COMPOSE_FILE) restart db
	@echo "âœ… Banco de dados reiniciado!"

# === LOGS E DEBUG ===
logs: ## Mostra logs de todos os serviÃ§os
	docker compose -f $(COMPOSE_FILE) logs -f

logs-web: ## Mostra logs apenas do serviÃ§o web
	docker compose -f $(COMPOSE_FILE) logs -f web

logs-react: ## Mostra logs apenas do serviÃ§o react
	docker compose -f $(COMPOSE_FILE) logs -f react-app

logs-db: ## Mostra logs apenas do banco de dados
	docker compose -f $(COMPOSE_FILE) logs -f db

logs-prod: ## Mostra logs da produÃ§Ã£o
	docker compose -f $(COMPOSE_FILE_PROD) logs -f

# === SHELL E DEBUG ===
shell: ## Acesso shell ao container web
	docker compose -f $(COMPOSE_FILE) exec web bash

shell-react: ## Acesso shell ao container react
	docker compose -f $(COMPOSE_FILE) exec react-app sh

shell-db: ## Acesso shell ao container do banco
	docker compose -f $(COMPOSE_FILE) exec db psql -U bruno -d P017

django-shell: ## Acesso ao Django shell
	docker compose -f $(COMPOSE_FILE) exec web python manage.py shell

# === DJANGO COMMANDS ===
migrate: ## Executa migraÃ§Ãµes do Django
	@echo "ğŸ”„ Executando migraÃ§Ãµes..."
	docker compose -f $(COMPOSE_FILE) exec web python manage.py migrate
	@echo "âœ… MigraÃ§Ãµes executadas!"

makemigrations: ## Cria novas migraÃ§Ãµes
	@echo "ğŸ”„ Criando migraÃ§Ãµes..."
	docker compose -f $(COMPOSE_FILE) exec web python manage.py makemigrations
	@echo "âœ… MigraÃ§Ãµes criadas!"

collectstatic: ## Coleta arquivos estÃ¡ticos
	@echo "ğŸ”„ Coletando arquivos estÃ¡ticos..."
	docker compose -f $(COMPOSE_FILE) exec web python manage.py collectstatic --noinput
	@echo "âœ… Arquivos estÃ¡ticos coletados!"

createsuperuser: ## Cria superusuÃ¡rio Django
	docker compose -f $(COMPOSE_FILE) exec web python manage.py createsuperuser

# === BACKUP E RESTORE ===
backup: ## Backup do banco de dados
	@echo "ğŸ’¾ Criando backup do banco de dados..."
	@mkdir -p $(BACKUP_DIR)
	docker compose -f $(COMPOSE_FILE) exec -T db pg_dump -U bruno P017 > $(BACKUP_DIR)/backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Backup criado em $(BACKUP_DIR)/"

restore: ## Restaura backup do banco (use: make restore FILE=backup.sql)
	@echo "ğŸ”„ Restaurando backup do banco de dados..."
	@if [ -z "$(FILE)" ]; then echo "âŒ Use: make restore FILE=nome_do_arquivo.sql"; exit 1; fi
	docker compose -f $(COMPOSE_FILE) exec -T db psql -U bruno -d P017 < $(BACKUP_DIR)/$(FILE)
	@echo "âœ… Backup restaurado!"

# === STATUS E MONITORAMENTO ===
status: ## Mostra status dos containers
	@echo "ğŸ“Š Status dos containers:"
	docker compose -f $(COMPOSE_FILE) ps

health: ## Verifica saÃºde dos serviÃ§os
	@echo "ğŸ¥ Verificando saÃºde dos serviÃ§os..."
	@echo "Web: http://localhost:8000/api/"
	@curl -f http://localhost:8000/api/ > /dev/null 2>&1 && echo "âœ… Web OK" || echo "âŒ Web com problemas"
	@echo "React: http://localhost:3001/"
	@curl -f http://localhost:3001/ > /dev/null 2>&1 && echo "âœ… React OK" || echo "âŒ React com problemas"
	@echo "Database:"
	@docker compose -f $(COMPOSE_FILE) exec db pg_isready -U bruno -d P017 > /dev/null 2>&1 && echo "âœ… Database OK" || echo "âŒ Database com problemas"

stats: ## Mostra estatÃ­sticas dos containers
	docker stats --no-stream

# === DESENVOLVIMENTO RÃPIDO ===
quick-restart: ## Restart rÃ¡pido (apenas restart dos containers)
	@echo "âš¡ Restart rÃ¡pido..."
	docker compose -f $(COMPOSE_FILE) restart web react-app
	@echo "âœ… Restart rÃ¡pido completo!"

hot-reload: ## ForÃ§a hot reload do Django
	@echo "ğŸ”¥ ForÃ§ando hot reload..."
	docker compose -f $(COMPOSE_FILE) exec web touch /app/manage.py
	@echo "âœ… Hot reload ativado!"

# === ALIASES ÃšTEIS ===
up: dev ## Alias para dev
down: dev-stop ## Alias para dev-stop
build: dev-build ## Alias para dev-build
restart: dev-restart ## Alias para dev-restart
